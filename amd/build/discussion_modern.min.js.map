{"version":3,"sources":["../src/discussion_modern.js"],"names":["getPostContainer","element","closest","Selectors","post","getPostContentContainer","postContainer","children","not","repliesContainer","find","forumCoreContent","getInPageReplyContainer","filter","inpageReplyContainer","showInPageReplyForm","inPageReplyContainer","afterAnimationCallback","form","inpageReplyContent","slideDown","duration","queue","complete","css","fadeIn","hideInPageReplyForm","slideUp","fadeOut","hasInPageReplyForm","length","renderInPageReplyTemplate","additionalTemplateContext","button","postContentContainer","currentSubject","forumSubject","text","currentAuthorName","authorName","context","postid","data","attr","sesskey","M","cfg","parentsubject","parentauthorname","canreplyprivately","postformat","InPageReply","CONTENT_FORMATS","MOODLE","Templates","render","registerEventListeners","root","CustomEvents","define","events","activate","AutoRows","init","on","inpageReplyCreateButton","e","originalEvent","preventDefault","currentTarget","html","appendNodeContents","Notification","exception","focus","inpageReplyCancelButton","inPageReplyCreateButton","Discussion","discussionToolsContainer","LockToggle","FavouriteToggle","Pin"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module for viewing a discussion in modern view.\n *\n * @copyright  2019 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport AutoRows from 'core/auto_rows';\nimport CustomEvents from 'core/custom_interaction_events';\nimport Notification from 'core/notification';\nimport Templates from 'core/templates';\nimport Discussion from 'mod_forum/discussion';\nimport InPageReply from 'mod_forum/inpage_reply';\nimport LockToggle from 'mod_forum/lock_toggle';\nimport FavouriteToggle from 'mod_forum/favourite_toggle';\nimport Pin from 'mod_forum/pin_toggle';\nimport Selectors from 'mod_forum/selectors';\n\nconst ANIMATION_DURATION = 150;\n\n/**\n * Get the closest post container element from the given element.\n *\n * @param {Object} element jQuery element to search from\n * @return {Object} jQuery element\n */\nconst getPostContainer = (element) => {\n    return element.closest(Selectors.post.post);\n};\n\n/**\n * Get the post content container element from the post container element.\n *\n * @param {Object} postContainer jQuery element for the post container\n * @return {Object} jQuery element\n */\nconst getPostContentContainer = (postContainer) => {\n    return postContainer.children().not(Selectors.post.repliesContainer).find(Selectors.post.forumCoreContent);\n};\n\n/**\n * Get the in page reply container element from the post container element.\n *\n * @param {Object} postContainer jQuery element for the post container\n * @return {Object} jQuery element\n */\nconst getInPageReplyContainer = (postContainer) => {\n    return postContainer.children().filter(Selectors.post.inpageReplyContainer);\n};\n\n/**\n * Show the in page reply form in the given in page reply container. The form\n * display will be animated.\n *\n * @param {Object} inPageReplyContainer jQuery element for the in page reply container\n * @param {Function} afterAnimationCallback Callback after animation completes\n */\nconst showInPageReplyForm = (inPageReplyContainer, afterAnimationCallback) => {\n    const form = inPageReplyContainer.find(Selectors.post.inpageReplyContent);\n\n    form.slideDown({\n        duration: ANIMATION_DURATION,\n        queue: false,\n        complete: afterAnimationCallback\n    }).css('display', 'none').fadeIn(ANIMATION_DURATION);\n};\n\n/**\n * Hide the in page reply form in the given in page reply container. The form\n * display will be animated.\n *\n * @param {Object} inPageReplyContainer jQuery element for the in page reply container\n * @param {Function} afterAnimationCallback Callback after animation completes\n */\nconst hideInPageReplyForm = (inPageReplyContainer, afterAnimationCallback) => {\n    const form = inPageReplyContainer.find(Selectors.post.inpageReplyContent);\n\n    form.slideUp({\n        duration: ANIMATION_DURATION,\n        queue: false,\n        complete: afterAnimationCallback\n    }).fadeOut(200);\n};\n\n/**\n * Check if the in page reply container contains the in page reply form.\n *\n * @param {Object} inPageReplyContainer jQuery element for the in page reply container\n * @return {Bool}\n */\nconst hasInPageReplyForm = (inPageReplyContainer) => {\n    return inPageReplyContainer.find(Selectors.post.inpageReplyContent).length > 0;\n};\n\n/**\n * Render the template to generate the in page reply form HTML.\n *\n * @param {Object} additionalTemplateContext Additional render context for the in page reply template\n * @param {Object} button jQuery element for the reply button that was clicked\n * @param {Object} postContainer jQuery element for the post container\n * @return {Object} jQuery promise\n */\nconst renderInPageReplyTemplate = (additionalTemplateContext, button, postContainer) => {\n    const postContentContainer = getPostContentContainer(postContainer);\n    const currentSubject = postContentContainer.find(Selectors.post.forumSubject).text();\n    const currentAuthorName = postContentContainer.find(Selectors.post.authorName).text();\n    const context = {\n        postid: postContainer.data('post-id'),\n        \"reply_url\": button.attr('data-href'),\n        sesskey: M.cfg.sesskey,\n        parentsubject: currentSubject,\n        parentauthorname: currentAuthorName,\n        canreplyprivately: button.data('can-reply-privately'),\n        postformat: InPageReply.CONTENT_FORMATS.MOODLE,\n        ...additionalTemplateContext\n    };\n\n    return Templates.render('mod_forum/inpage_reply_modern', context);\n};\n\n/**\n * Create all of the event listeners for the discussion.\n *\n * @param {Object} root jQuery element for the discussion container\n * @param {Object} additionalTemplateContext Additional render context for the in page reply template\n */\nconst registerEventListeners = (root, additionalTemplateContext) => {\n    CustomEvents.define(root, [CustomEvents.events.activate]);\n    // Auto expanding text area for in page reply.\n    AutoRows.init(root);\n\n    // Reply button is clicked.\n    root.on(CustomEvents.events.activate, Selectors.post.inpageReplyCreateButton, async (e, data) => {\n        data.originalEvent.preventDefault();\n\n        const button = $(e.currentTarget);\n        const postContainer = getPostContainer(button);\n        const inPageReplyContainer = getInPageReplyContainer(postContainer);\n\n        if (!hasInPageReplyForm(inPageReplyContainer)) {\n            try {\n                const html = await renderInPageReplyTemplate(additionalTemplateContext, button, postContainer);\n                Templates.appendNodeContents(inPageReplyContainer, html, '');\n            } catch (e) {\n                Notification.exception(e);\n            }\n        }\n\n        button.fadeOut(ANIMATION_DURATION, () => {\n            showInPageReplyForm(inPageReplyContainer, () => {\n                inPageReplyContainer.find(Selectors.post.inpageReplyContent).find('textarea').focus();\n            });\n        });\n    });\n\n    // Cancel in page reply button.\n    root.on(CustomEvents.events.activate, Selectors.post.inpageReplyCancelButton, (e, data) => {\n        data.originalEvent.preventDefault();\n\n        const button = $(e.currentTarget);\n        const postContainer = getPostContainer(button);\n        const postContentContainer = getPostContentContainer(postContainer);\n        const inPageReplyContainer = getInPageReplyContainer(postContainer);\n        const inPageReplyCreateButton = postContentContainer.find(Selectors.post.inpageReplyCreateButton);\n        hideInPageReplyForm(inPageReplyContainer, () => {\n            inPageReplyCreateButton.fadeIn(ANIMATION_DURATION);\n        });\n    });\n};\n\n/**\n * Initialise the javascript for the discussion in modern display mode.\n *\n * @param {Object} root jQuery element for the discussion container\n * @param {Object} context Additional render context for the in page reply template\n */\nexport const init = (root, context) => {\n    // Add discussion event listeners.\n    registerEventListeners(root, context);\n    // Add default discussion javascript (keyboard nav etc).\n    Discussion.init(root);\n    // Add in page reply javascript.\n    InPageReply.init(root);\n\n    // Initialise the settings menu javascript.\n    const discussionToolsContainer = root.find('[data-container=\"discussion-tools\"]');\n    LockToggle.init(discussionToolsContainer);\n    FavouriteToggle.init(discussionToolsContainer);\n    Pin.init(discussionToolsContainer);\n};\n"],"file":"discussion_modern.min.js"}